// src/app/(dashboard)/admin/obras/[id]/partidas/page.tsx
'use client'

import { useState, useEffect, useCallback } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { Textarea } from '@/components/ui/textarea'
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { toast } from 'sonner'
import { ArrowLeft, Plus, Loader2, DollarSign, Layers, ChevronDown, ChevronRight, Edit, Trash2, Upload, FileText, Image as ImageIcon, Download, Eye, X, Calendar, FolderOpen, Receipt, Banknote, AlertCircle, Clock, ListTodo, FileSpreadsheet } from 'lucide-react'

interface Obra { id_obra: number; nombre_obra: string; presupuesto_inicial: number; estado: string; fecha_inicio_prevista: string; fecha_fin_prevista: string }
interface Gasto { id_gasto: number; monto: number; descripcion: string | null; fecha_gasto: string; tipo_comprobante: string | null; numero_comprobante: string | null; usuario: { nombre: string; apellido: string } | null; archivo: { id_documento: number; nombre_archivo: string; ruta_archivo: string; formato: string } | null }
interface Actividad { id_actividad: number; nombre_actividad: string; descripcion: string | null; fecha_inicio: string; fecha_fin: string; archivos_count: number }
interface Partida { id_partida: number; nombre_partida: string; monto_asignado: number; monto_ejecutado: number; avance_porcentaje: number; archivos_count: number; actividades: Actividad[] }
interface Documento { id_documento: number; nombre_archivo: string; ruta_archivo: string; formato: string; fecha_carga: string; carpeta_tipo: { nombre_carpeta: string; codigo: string } | null }
interface Carpeta { id_carpeta_tipo: number; codigo: string; nombre_carpeta: string }

const COLORES_ESTADO: Record<string, string> = { 'PLANEADA': 'bg-blue-100 text-blue-800', 'EN_EJECUCION': 'bg-yellow-100 text-yellow-800', 'CONCLUIDA': 'bg-green-100 text-green-800', 'LIQUIDADA': 'bg-purple-100 text-purple-800' }
const TIPOS_COMPROBANTE = [ { value: 'FACTURA', label: 'Factura' }, { value: 'BOLETA', label: 'Boleta' }, { value: 'RECIBO', label: 'Recibo por Honorarios' }, { value: 'VALE', label: 'Vale de Caja' }, { value: 'NOTA_CREDITO', label: 'Nota de Crédito' }, { value: 'OTRO', label: 'Otro' } ]

export default function PartidasPage() {
  const params = useParams()
  const router = useRouter()
  const obraId = params.id as string

  const [obra, setObra] = useState<Obra | null>(null)
  const [partidas, setPartidas] = useState<Partida[]>([])
  const [documentosObra, setDocumentosObra] = useState<Documento[]>([])
  const [carpetas, setCarpetas] = useState<Carpeta[]>([])
  const [loading, setLoading] = useState(true)
  const [expandedPartidas, setExpandedPartidas] = useState<Set<number>>(new Set())
  const [expandedActividades, setExpandedActividades] = useState<Set<number>>(new Set())
  const [editingMonto, setEditingMonto] = useState<number | null>(null)
  const [montoTemp, setMontoTemp] = useState('')
  const [showPartidaDialog, setShowPartidaDialog] = useState(false)
  const [showActividadDialog, setShowActividadDialog] = useState(false)
  const [showArchivoDialog, setShowArchivoDialog] = useState(false)
  const [showPreviewDialog, setShowPreviewDialog] = useState(false)
  const [showDeletePartidaDialog, setShowDeletePartidaDialog] = useState(false)
  const [showDeleteActividadDialog, setShowDeleteActividadDialog] = useState(false)
  const [showDeleteArchivoDialog, setShowDeleteArchivoDialog] = useState(false)
  const [showEditPartidaDialog, setShowEditPartidaDialog] = useState(false)
  const [showEditActividadDialog, setShowEditActividadDialog] = useState(false)
  const [showGastoDialog, setShowGastoDialog] = useState(false)
  const [showEditGastoDialog, setShowEditGastoDialog] = useState(false)
  const [showDeleteGastoDialog, setShowDeleteGastoDialog] = useState(false)
  const [selectedPartida, setSelectedPartida] = useState<Partida | null>(null)
  const [selectedActividad, setSelectedActividad] = useState<Actividad | null>(null)
  const [selectedDocumento, setSelectedDocumento] = useState<Documento | null>(null)
  const [selectedGasto, setSelectedGasto] = useState<Gasto | null>(null)
  const [archivosPartida, setArchivosPartida] = useState<Documento[]>([])
  const [archivosActividad, setArchivosActividad] = useState<Documento[]>([])
  const [gastosActividad, setGastosActividad] = useState<Gasto[]>([])
  const [loadingGastos, setLoadingGastos] = useState(false)
  const [uploadContext, setUploadContext] = useState<{ tipo: 'obra' | 'partida' | 'actividad'; partidaId?: number; actividadId?: number }>({ tipo: 'obra' })
  const [partidaForm, setPartidaForm] = useState({ nombre_partida: '', monto_asignado: '', archivo: null as File | null, carpeta_id: '1' })
  const [actividadForm, setActividadForm] = useState({ nombre_actividad: '', descripcion: '', fecha_inicio: '', fecha_fin: '', archivo: null as File | null, carpeta_id: '1' })
  const [archivoForm, setArchivoForm] = useState({ archivo: null as File | null, carpeta_id: '1', descripcion: '' })
  const [gastoForm, setGastoForm] = useState({ monto: '', descripcion: '', fecha_gasto: new Date().toISOString().split('T')[0], tipo_comprobante: '', numero_comprobante: '', archivo: null as File | null })
  const [saving, setSaving] = useState(false)
  const [activeTab, setActiveTab] = useState('archivos')

  const fetchObra = useCallback(async () => { try { const res = await fetch(`/api/admin/obras/${obraId}`); const data = await res.json(); if (data.obra) setObra(data.obra) } catch (error) { console.error('Error:', error); toast.error('Error al cargar obra') } }, [obraId])
  const fetchPartidas = useCallback(async () => { try { const res = await fetch(`/api/admin/obras/${obraId}/partidas`); const data = await res.json(); if (data.partidas) setPartidas(data.partidas) } catch (error) { console.error('Error:', error) } finally { setLoading(false) } }, [obraId])
  const fetchDocumentosObra = useCallback(async () => { try { const res = await fetch(`/api/admin/obras/${obraId}/archivos?only_general=true`); const data = await res.json(); if (data.documentos) setDocumentosObra(data.documentos) } catch (error) { console.error('Error:', error) } }, [obraId])
  const fetchCarpetas = useCallback(async () => { try { const res = await fetch('/api/admin/carpetas'); const data = await res.json(); if (data.carpetas) setCarpetas(data.carpetas) } catch (error) { console.error('Error:', error) } }, [])
  const fetchArchivosPartida = async (partidaId: number) => { try { const res = await fetch(`/api/admin/obras/${obraId}/archivos?partida_id=${partidaId}`); const data = await res.json(); setArchivosPartida(data.documentos || []) } catch (error) { console.error('Error:', error) } }
  const fetchArchivosActividad = async (actividadId: number) => { try { const res = await fetch(`/api/admin/obras/${obraId}/archivos?actividad_id=${actividadId}`); const data = await res.json(); setArchivosActividad(data.documentos || []) } catch (error) { console.error('Error:', error) } }
  const fetchGastosActividad = async (partidaId: number, actividadId: number) => { setLoadingGastos(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${partidaId}/actividades/${actividadId}/gastos`); const data = await res.json(); setGastosActividad(data.gastos || []) } catch (error) { console.error('Error:', error); setGastosActividad([]) } finally { setLoadingGastos(false) } }

  useEffect(() => { fetchObra(); fetchPartidas(); fetchDocumentosObra(); fetchCarpetas() }, [fetchObra, fetchPartidas, fetchDocumentosObra, fetchCarpetas])

  const togglePartida = async (partidaId: number) => { const newExpanded = new Set(expandedPartidas); if (newExpanded.has(partidaId)) { newExpanded.delete(partidaId) } else { newExpanded.add(partidaId); await fetchArchivosPartida(partidaId) } setExpandedPartidas(newExpanded) }
  const toggleActividad = async (partida: Partida, actividad: Actividad) => { const newExpanded = new Set(expandedActividades); if (newExpanded.has(actividad.id_actividad)) { newExpanded.delete(actividad.id_actividad) } else { newExpanded.add(actividad.id_actividad); await fetchArchivosActividad(actividad.id_actividad); await fetchGastosActividad(partida.id_partida, actividad.id_actividad); setSelectedPartida(partida); setSelectedActividad(actividad) } setExpandedActividades(newExpanded) }

  const handleCreatePartida = async () => { if (!partidaForm.nombre_partida) { toast.error('Ingrese el nombre'); return } setSaving(true); try { const formData = new FormData(); formData.append('nombre_partida', partidaForm.nombre_partida); formData.append('monto_asignado', partidaForm.monto_asignado || '0'); if (partidaForm.archivo) { formData.append('archivo', partidaForm.archivo); formData.append('carpeta_id', partidaForm.carpeta_id) } const res = await fetch(`/api/admin/obras/${obraId}/partidas`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Error'); toast.success('Partida creada'); setShowPartidaDialog(false); setPartidaForm({ nombre_partida: '', monto_asignado: '', archivo: null, carpeta_id: '1' }); fetchPartidas() } catch { toast.error('Error al crear') } finally { setSaving(false) } }
  const handleEditPartida = async () => { if (!selectedPartida) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre_partida: partidaForm.nombre_partida, monto_asignado: parseFloat(partidaForm.monto_asignado) || 0 }) }); if (!res.ok) throw new Error('Error'); toast.success('Actualizado'); setShowEditPartidaDialog(false); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleDeletePartida = async () => { if (!selectedPartida) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}`, { method: 'DELETE' }); if (!res.ok) throw new Error('Error'); toast.success('Eliminado'); setShowDeletePartidaDialog(false); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleUpdateMontoEjecutado = async (partidaId: number, nuevoMonto: string) => { try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${partidaId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ monto_ejecutado: parseFloat(nuevoMonto) || 0 }) }); if (!res.ok) throw new Error('Error'); toast.success('Actualizado'); fetchPartidas() } catch { toast.error('Error') } finally { setEditingMonto(null) } }
  const handleCreateActividad = async () => { if (!selectedPartida || !actividadForm.nombre_actividad || !actividadForm.fecha_inicio || !actividadForm.fecha_fin) { toast.error('Complete los campos'); return } setSaving(true); try { const formData = new FormData(); formData.append('nombre_actividad', actividadForm.nombre_actividad); formData.append('descripcion', actividadForm.descripcion); formData.append('fecha_inicio', actividadForm.fecha_inicio); formData.append('fecha_fin', actividadForm.fecha_fin); if (actividadForm.archivo) { formData.append('archivo', actividadForm.archivo); formData.append('carpeta_id', actividadForm.carpeta_id) } const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Error'); toast.success('Actividad creada'); setShowActividadDialog(false); setActividadForm({ nombre_actividad: '', descripcion: '', fecha_inicio: '', fecha_fin: '', archivo: null, carpeta_id: '1' }); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleEditActividad = async () => { if (!selectedPartida || !selectedActividad) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades/${selectedActividad.id_actividad}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre_actividad: actividadForm.nombre_actividad, descripcion: actividadForm.descripcion, fecha_inicio: actividadForm.fecha_inicio, fecha_fin: actividadForm.fecha_fin }) }); if (!res.ok) throw new Error('Error'); toast.success('Actualizado'); setShowEditActividadDialog(false); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleDeleteActividad = async () => { if (!selectedPartida || !selectedActividad) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades/${selectedActividad.id_actividad}`, { method: 'DELETE' }); if (!res.ok) throw new Error('Error'); toast.success('Eliminado'); setShowDeleteActividadDialog(false); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleCreateGasto = async () => { if (!selectedPartida || !selectedActividad) { toast.error('Seleccione actividad'); return } if (!gastoForm.monto || parseFloat(gastoForm.monto) <= 0) { toast.error('Monto inválido'); return } if (!gastoForm.fecha_gasto) { toast.error('Ingrese fecha'); return } setSaving(true); try { const formData = new FormData(); formData.append('monto', gastoForm.monto); formData.append('descripcion', gastoForm.descripcion); formData.append('fecha_gasto', gastoForm.fecha_gasto); formData.append('tipo_comprobante', gastoForm.tipo_comprobante); formData.append('numero_comprobante', gastoForm.numero_comprobante); if (gastoForm.archivo) formData.append('archivo', gastoForm.archivo); const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades/${selectedActividad.id_actividad}/gastos`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Error'); toast.success('Gasto registrado'); setShowGastoDialog(false); setGastoForm({ monto: '', descripcion: '', fecha_gasto: new Date().toISOString().split('T')[0], tipo_comprobante: '', numero_comprobante: '', archivo: null }); await fetchGastosActividad(selectedPartida.id_partida, selectedActividad.id_actividad); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleEditGasto = async () => { if (!selectedPartida || !selectedActividad || !selectedGasto) return; setSaving(true); try { const formData = new FormData(); formData.append('monto', gastoForm.monto); formData.append('descripcion', gastoForm.descripcion); formData.append('fecha_gasto', gastoForm.fecha_gasto); formData.append('tipo_comprobante', gastoForm.tipo_comprobante); formData.append('numero_comprobante', gastoForm.numero_comprobante); if (gastoForm.archivo) formData.append('archivo', gastoForm.archivo); const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades/${selectedActividad.id_actividad}/gastos/${selectedGasto.id_gasto}`, { method: 'PUT', body: formData }); if (!res.ok) throw new Error('Error'); toast.success('Actualizado'); setShowEditGastoDialog(false); await fetchGastosActividad(selectedPartida.id_partida, selectedActividad.id_actividad); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleDeleteGasto = async () => { if (!selectedPartida || !selectedActividad || !selectedGasto) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/partidas/${selectedPartida.id_partida}/actividades/${selectedActividad.id_actividad}/gastos/${selectedGasto.id_gasto}`, { method: 'DELETE' }); if (!res.ok) throw new Error('Error'); toast.success('Eliminado'); setShowDeleteGastoDialog(false); await fetchGastosActividad(selectedPartida.id_partida, selectedActividad.id_actividad); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleUploadArchivo = async () => { if (!archivoForm.archivo) { toast.error('Seleccione archivo'); return } setSaving(true); try { const formData = new FormData(); formData.append('archivo', archivoForm.archivo); formData.append('carpeta_id', archivoForm.carpeta_id); formData.append('descripcion', archivoForm.descripcion); if (uploadContext.tipo === 'partida' && uploadContext.partidaId) formData.append('partida_id', String(uploadContext.partidaId)); else if (uploadContext.tipo === 'actividad' && uploadContext.actividadId) formData.append('actividad_id', String(uploadContext.actividadId)); const res = await fetch(`/api/admin/obras/${obraId}/archivos`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Error'); toast.success('Archivo subido'); setShowArchivoDialog(false); setArchivoForm({ archivo: null, carpeta_id: '1', descripcion: '' }); if (uploadContext.tipo === 'obra') fetchDocumentosObra(); else if (uploadContext.tipo === 'partida' && uploadContext.partidaId) { fetchArchivosPartida(uploadContext.partidaId); fetchPartidas() } else if (uploadContext.tipo === 'actividad' && uploadContext.actividadId) { fetchArchivosActividad(uploadContext.actividadId); fetchPartidas() } } catch { toast.error('Error') } finally { setSaving(false) } }
  const handleDeleteArchivo = async () => { if (!selectedDocumento) return; setSaving(true); try { const res = await fetch(`/api/admin/obras/${obraId}/archivos/${selectedDocumento.id_documento}`, { method: 'DELETE' }); if (!res.ok) throw new Error('Error'); toast.success('Eliminado'); setShowDeleteArchivoDialog(false); fetchDocumentosObra(); fetchPartidas() } catch { toast.error('Error') } finally { setSaving(false) } }
  const openUploadDialog = (tipo: 'obra' | 'partida' | 'actividad', partidaId?: number, actividadId?: number) => { setUploadContext({ tipo, partidaId, actividadId }); setArchivoForm({ archivo: null, carpeta_id: '1', descripcion: '' }); setShowArchivoDialog(true) }
  const openGastoDialog = (partida: Partida, actividad: Actividad) => { setSelectedPartida(partida); setSelectedActividad(actividad); setGastoForm({ monto: '', descripcion: '', fecha_gasto: new Date().toISOString().split('T')[0], tipo_comprobante: '', numero_comprobante: '', archivo: null }); setShowGastoDialog(true) }

  const totalAsignado = partidas.reduce((sum, p) => sum + Number(p.monto_asignado), 0)
  const totalEjecutado = partidas.reduce((sum, p) => sum + Number(p.monto_ejecutado), 0)
  const avanceGeneral = totalAsignado > 0 ? (totalEjecutado / totalAsignado) * 100 : 0
  const totalActividades = partidas.reduce((sum, p) => sum + p.actividades.length, 0)
  const getFileIcon = (formato: string) => { const lower = formato.toLowerCase(); if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(lower)) return <ImageIcon className="h-4 w-4 text-blue-500" />; return <FileText className={`h-4 w-4 ${lower === 'pdf' ? 'text-red-500' : 'text-gray-500'}`} /> }
  const calcularDias = (inicio: string, fin: string) => Math.ceil(Math.abs(new Date(fin).getTime() - new Date(inicio).getTime()) / (1000 * 60 * 60 * 24))
  const formatCurrency = (v: number) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(v)

  if (loading) return <div className="flex items-center justify-center h-64"><Loader2 className="h-8 w-8 animate-spin text-gray-400" /></div>

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" onClick={() => router.push('/admin/obras')}><ArrowLeft className="h-5 w-5" /></Button>
        <div className="flex-1">
          <h1 className="text-2xl font-bold text-gray-900 uppercase">{obra?.nombre_obra}</h1>
          <p className="text-sm text-gray-500">{obra?.fecha_inicio_prevista && new Date(obra.fecha_inicio_prevista).toLocaleDateString()} - {obra?.fecha_fin_prevista && new Date(obra.fecha_fin_prevista).toLocaleDateString()}</p>
        </div>
        <Badge className={COLORES_ESTADO[obra?.estado || '']}>{obra?.estado?.replace('_', ' ')}</Badge>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200"><CardContent className="pt-4"><div className="flex items-center gap-3"><div className="p-2 bg-green-500 rounded-lg"><DollarSign className="h-5 w-5 text-white" /></div><div><p className="text-xs text-green-700">Financiamiento</p><p className="text-lg font-bold text-green-900">{formatCurrency(Number(obra?.presupuesto_inicial || 0))}</p></div></div></CardContent></Card>
        <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200"><CardContent className="pt-4"><div className="flex items-center gap-3"><div className="p-2 bg-blue-500 rounded-lg"><Layers className="h-5 w-5 text-white" /></div><div><p className="text-xs text-blue-700">Partidas</p><p className="text-lg font-bold text-blue-900">{partidas.length}</p></div></div></CardContent></Card>
        <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200"><CardContent className="pt-4"><div className="flex items-center gap-3"><div className="p-2 bg-purple-500 rounded-lg"><ListTodo className="h-5 w-5 text-white" /></div><div><p className="text-xs text-purple-700">Actividades</p><p className="text-lg font-bold text-purple-900">{totalActividades}</p></div></div></CardContent></Card>
        <Card className="bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200"><CardContent className="pt-4"><div className="flex items-center gap-3"><div className="p-2 bg-emerald-500 rounded-lg"><Banknote className="h-5 w-5 text-white" /></div><div><p className="text-xs text-emerald-700">Ejecutado</p><p className="text-lg font-bold text-emerald-900">{formatCurrency(totalEjecutado)}</p></div></div></CardContent></Card>
        <Card className="bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200"><CardContent className="pt-4"><div><p className="text-xs text-amber-700">Avance</p><p className="text-lg font-bold text-amber-900 mb-1">{avanceGeneral.toFixed(1)}%</p><div className="w-full h-2 bg-amber-200 rounded-full overflow-hidden"><div className={`h-full rounded-full ${avanceGeneral >= 100 ? 'bg-green-500' : 'bg-amber-500'}`} style={{ width: `${Math.min(avanceGeneral, 100)}%` }} /></div></div></CardContent></Card>
      </div>

      {/* Actions */}
      <div className="flex flex-wrap gap-2">
        <Button onClick={() => { setPartidaForm({ nombre_partida: '', monto_asignado: '', archivo: null, carpeta_id: '1' }); setShowPartidaDialog(true) }}><Plus className="h-4 w-4 mr-2" /> Nueva Partida</Button>
        <Button variant="outline" onClick={() => openUploadDialog('obra')}><Upload className="h-4 w-4 mr-2" /> Documento General</Button>
      </div>

      {/* Documentos generales */}
      {documentosObra.length > 0 && (
        <Card><CardHeader className="pb-3"><CardTitle className="text-base flex items-center gap-2"><FolderOpen className="h-4 w-4" /> Documentos Generales ({documentosObra.length})</CardTitle></CardHeader><CardContent><div className="grid gap-2">{documentosObra.map(doc => (<div key={doc.id_documento} className="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100"><div className="flex items-center gap-2">{getFileIcon(doc.formato)}<span className="text-sm font-medium">{doc.nombre_archivo}</span><Badge variant="outline" className="text-xs">{doc.carpeta_tipo?.codigo || 'N/A'}</Badge></div><div className="flex items-center gap-1"><Button variant="ghost" size="sm" onClick={() => { setSelectedDocumento(doc); setShowPreviewDialog(true) }}><Eye className="h-4 w-4" /></Button><Button variant="ghost" size="sm" onClick={() => window.open(doc.ruta_archivo, '_blank')}><Download className="h-4 w-4" /></Button><Button variant="ghost" size="sm" className="text-red-600" onClick={() => { setSelectedDocumento(doc); setShowDeleteArchivoDialog(true) }}><Trash2 className="h-4 w-4" /></Button></div></div>))}</div></CardContent></Card>
      )}

      {/* Partidas */}
      <div className="space-y-4">
        {partidas.length === 0 ? (
          <Card><CardContent className="py-12 text-center"><Layers className="h-12 w-12 mx-auto text-gray-300 mb-4" /><p className="text-gray-500">No hay partidas</p></CardContent></Card>
        ) : partidas.map(partida => (
          <Card key={partida.id_partida} className="border-l-4 border-l-blue-500">
            <CardContent className="pt-4">
              <div className="flex items-start gap-3">
                <button onClick={() => togglePartida(partida.id_partida)} className="p-1 hover:bg-gray-100 rounded mt-1">{expandedPartidas.has(partida.id_partida) ? <ChevronDown className="h-5 w-5" /> : <ChevronRight className="h-5 w-5" />}</button>
                <div className="flex-1">
                  <div className="flex items-center justify-between">
                    <div><h3 className="font-semibold">{partida.nombre_partida}</h3><p className="text-sm text-gray-500">Asignado: {formatCurrency(Number(partida.monto_asignado))}</p></div>
                    <div className="text-right"><div className="flex items-center gap-2"><div className="w-32 h-2 bg-gray-200 rounded-full"><div className={`h-full rounded-full ${partida.avance_porcentaje >= 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${Math.min(partida.avance_porcentaje, 100)}%` }} /></div><span className="text-sm font-semibold">{partida.avance_porcentaje.toFixed(1)}%</span></div><p className="text-xs text-gray-400">Ejecutado: {formatCurrency(Number(partida.monto_ejecutado))}</p></div>
                  </div>
                  <div className="flex items-center gap-2 mt-3">
                    <Button variant="outline" size="sm" onClick={() => { setSelectedPartida(partida); setPartidaForm({ nombre_partida: partida.nombre_partida, monto_asignado: String(partida.monto_asignado), archivo: null, carpeta_id: '1' }); setShowEditPartidaDialog(true) }}><Edit className="h-4 w-4 mr-1" /> Editar</Button>
                    <Button variant="outline" size="sm" onClick={() => { setSelectedPartida(partida); setActividadForm({ nombre_actividad: '', descripcion: '', fecha_inicio: '', fecha_fin: '', archivo: null, carpeta_id: '1' }); setShowActividadDialog(true) }}><Plus className="h-4 w-4 mr-1" /> Actividad</Button>
                    <Button variant="outline" size="sm" onClick={() => openUploadDialog('partida', partida.id_partida)}><Upload className="h-4 w-4 mr-1" /> Archivo</Button>
                    <Button variant="outline" size="sm" className="text-red-600" onClick={() => { setSelectedPartida(partida); setShowDeletePartidaDialog(true) }}><Trash2 className="h-4 w-4 mr-1" /> Eliminar</Button>
                  </div>
                  <div className="flex items-center gap-2 mt-3 p-2 bg-gray-50 rounded">
                    <Receipt className="h-4 w-4 text-gray-400" /><span className="text-sm font-medium">Monto Ejecutado:</span>
                    {editingMonto === partida.id_partida ? (<Input type="number" className="w-32 h-8" value={montoTemp} onChange={(e) => setMontoTemp(e.target.value)} onBlur={() => handleUpdateMontoEjecutado(partida.id_partida, montoTemp)} onKeyDown={(e) => { if (e.key === 'Enter') handleUpdateMontoEjecutado(partida.id_partida, montoTemp); if (e.key === 'Escape') setEditingMonto(null) }} autoFocus />) : (<button className="text-sm text-blue-600 hover:underline font-medium" onClick={() => { setEditingMonto(partida.id_partida); setMontoTemp(String(partida.monto_ejecutado)) }}>{formatCurrency(Number(partida.monto_ejecutado))}</button>)}
                    <span className="text-xs text-gray-400">de {formatCurrency(Number(partida.monto_asignado))}</span>
                  </div>
                </div>
              </div>

              {expandedPartidas.has(partida.id_partida) && (
                <div className="mt-4 ml-9 space-y-4">
                  <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <div className="flex items-center justify-between mb-2"><h4 className="text-sm font-medium text-blue-800 flex items-center gap-2"><FolderOpen className="h-4 w-4" /> Archivos</h4><Button size="sm" variant="outline" className="h-7" onClick={() => openUploadDialog('partida', partida.id_partida)}><Upload className="h-3 w-3 mr-1" /> Subir</Button></div>
                    {archivosPartida.filter(a => !a.ruta_archivo.includes('/actividad_')).length === 0 ? <p className="text-sm text-gray-500">Sin archivos</p> : (<div className="space-y-1">{archivosPartida.filter(a => !a.ruta_archivo.includes('/actividad_')).map(doc => (<div key={doc.id_documento} className="flex items-center justify-between p-2 bg-white rounded border"><div className="flex items-center gap-2">{getFileIcon(doc.formato)}<span className="text-sm">{doc.nombre_archivo}</span></div><div className="flex items-center gap-1"><Button variant="ghost" size="sm" className="h-7 w-7 p-0" onClick={() => { setSelectedDocumento(doc); setShowPreviewDialog(true) }}><Eye className="h-3 w-3" /></Button><Button variant="ghost" size="sm" className="h-7 w-7 p-0" onClick={() => window.open(doc.ruta_archivo, '_blank')}><Download className="h-3 w-3" /></Button><Button variant="ghost" size="sm" className="h-7 w-7 p-0 text-red-600" onClick={() => { setSelectedDocumento(doc); setShowDeleteArchivoDialog(true) }}><Trash2 className="h-3 w-3" /></Button></div></div>))}</div>)}
                  </div>

                  {partida.actividades.length > 0 && (
                    <div className="space-y-3">
                      <h4 className="text-sm font-semibold flex items-center gap-2"><ListTodo className="h-4 w-4" /> Actividades ({partida.actividades.length})</h4>
                      {partida.actividades.map(actividad => (
                        <div key={actividad.id_actividad} className="border rounded-lg bg-white shadow-sm">
                          <div className="p-3 hover:bg-gray-50">
                            <div className="flex items-start gap-2">
                              <button onClick={() => toggleActividad(partida, actividad)} className="p-1 hover:bg-gray-200 rounded">{expandedActividades.has(actividad.id_actividad) ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}</button>
                              <div className="flex-1">
                                <div className="flex items-center justify-between"><div><p className="font-medium text-sm">{actividad.nombre_actividad}</p>{actividad.descripcion && <p className="text-xs text-gray-500">{actividad.descripcion}</p>}</div><Badge variant="outline" className="text-xs"><FileText className="h-3 w-3 mr-1" /> {actividad.archivos_count}</Badge></div>
                                <div className="flex items-center gap-4 mt-2 text-xs text-gray-500"><span className="flex items-center gap-1"><Calendar className="h-3 w-3" />{new Date(actividad.fecha_inicio).toLocaleDateString()} - {new Date(actividad.fecha_fin).toLocaleDateString()}</span><span className="flex items-center gap-1"><Clock className="h-3 w-3" />{calcularDias(actividad.fecha_inicio, actividad.fecha_fin)} días</span></div>
                                <div className="flex items-center gap-2 mt-2">
                                  <Button variant="outline" size="sm" className="h-7 text-xs" onClick={() => { setSelectedPartida(partida); setSelectedActividad(actividad); setActividadForm({ nombre_actividad: actividad.nombre_actividad, descripcion: actividad.descripcion || '', fecha_inicio: actividad.fecha_inicio.split('T')[0], fecha_fin: actividad.fecha_fin.split('T')[0], archivo: null, carpeta_id: '1' }); setShowEditActividadDialog(true) }}><Edit className="h-3 w-3 mr-1" /> Editar</Button>
                                  <Button variant="outline" size="sm" className="h-7 text-xs bg-green-50 text-green-700 border-green-200" onClick={() => openGastoDialog(partida, actividad)}><Receipt className="h-3 w-3 mr-1" /> Registrar Gasto</Button>
                                  <Button variant="outline" size="sm" className="h-7 text-xs" onClick={() => openUploadDialog('actividad', partida.id_partida, actividad.id_actividad)}><Upload className="h-3 w-3 mr-1" /> Archivo</Button>
                                  <Button variant="outline" size="sm" className="h-7 text-xs text-red-600" onClick={() => { setSelectedPartida(partida); setSelectedActividad(actividad); setShowDeleteActividadDialog(true) }}><Trash2 className="h-3 w-3 mr-1" /> Eliminar</Button>
                                </div>
                              </div>
                            </div>
                          </div>
                          {expandedActividades.has(actividad.id_actividad) && (
                            <div className="border-t">
                              <Tabs value={activeTab} onValueChange={setActiveTab}>
                                <TabsList className="w-full rounded-none border-b bg-gray-50"><TabsTrigger value="archivos" className="flex-1 text-xs"><FileText className="h-3 w-3 mr-1" /> Archivos</TabsTrigger><TabsTrigger value="gastos" className="flex-1 text-xs"><Receipt className="h-3 w-3 mr-1" /> Gastos</TabsTrigger></TabsList>
                                <TabsContent value="archivos" className="p-3 m-0">
                                  <div className="flex items-center justify-between mb-2"><h5 className="text-xs font-medium">Archivos</h5><Button size="sm" variant="outline" className="h-6 text-xs" onClick={() => openUploadDialog('actividad', partida.id_partida, actividad.id_actividad)}><Upload className="h-3 w-3 mr-1" /> Subir</Button></div>
                                  {archivosActividad.length === 0 ? <p className="text-xs text-gray-500 text-center py-4">Sin archivos</p> : (<div className="space-y-1">{archivosActividad.map(doc => (<div key={doc.id_documento} className="flex items-center justify-between p-2 bg-gray-50 rounded text-xs"><div className="flex items-center gap-2">{getFileIcon(doc.formato)}<span>{doc.nombre_archivo}</span></div><div className="flex items-center gap-1"><Button variant="ghost" size="sm" className="h-6 w-6 p-0" onClick={() => { setSelectedDocumento(doc); setShowPreviewDialog(true) }}><Eye className="h-3 w-3" /></Button><Button variant="ghost" size="sm" className="h-6 w-6 p-0" onClick={() => window.open(doc.ruta_archivo, '_blank')}><Download className="h-3 w-3" /></Button><Button variant="ghost" size="sm" className="h-6 w-6 p-0 text-red-600" onClick={() => { setSelectedDocumento(doc); setShowDeleteArchivoDialog(true) }}><Trash2 className="h-3 w-3" /></Button></div></div>))}</div>)}
                                </TabsContent>
                                <TabsContent value="gastos" className="p-3 m-0">
                                  <div className="flex items-center justify-between mb-3"><div><h5 className="text-xs font-medium">Gastos</h5>{gastosActividad.length > 0 && <p className="text-xs text-green-600 font-semibold">Total: {formatCurrency(gastosActividad.reduce((s, g) => s + Number(g.monto), 0))}</p>}</div><Button size="sm" className="h-6 text-xs bg-green-600 hover:bg-green-700" onClick={() => openGastoDialog(partida, actividad)}><Plus className="h-3 w-3 mr-1" /> Nuevo Gasto</Button></div>
                                  {loadingGastos ? <div className="flex justify-center py-4"><Loader2 className="h-5 w-5 animate-spin" /></div> : gastosActividad.length === 0 ? (<div className="text-center py-6 bg-gray-50 rounded-lg"><Receipt className="h-8 w-8 mx-auto text-gray-300 mb-2" /><p className="text-xs text-gray-500">Sin gastos registrados</p></div>) : (<div className="space-y-2">{gastosActividad.map(gasto => (<div key={gasto.id_gasto} className="p-3 bg-gray-50 rounded-lg border"><div className="flex items-start justify-between"><div className="flex-1"><div className="flex items-center gap-2"><span className="text-sm font-bold text-green-700">{formatCurrency(Number(gasto.monto))}</span>{gasto.tipo_comprobante && <Badge variant="outline" className="text-xs">{TIPOS_COMPROBANTE.find(t => t.value === gasto.tipo_comprobante)?.label || gasto.tipo_comprobante}</Badge>}</div>{gasto.descripcion && <p className="text-xs text-gray-600 mt-1">{gasto.descripcion}</p>}<div className="flex items-center gap-3 mt-2 text-xs text-gray-500"><span className="flex items-center gap-1"><Calendar className="h-3 w-3" />{new Date(gasto.fecha_gasto).toLocaleDateString()}</span>{gasto.numero_comprobante && <span className="flex items-center gap-1"><FileSpreadsheet className="h-3 w-3" />N° {gasto.numero_comprobante}</span>}</div></div><div className="flex items-center gap-1">{gasto.archivo && <><Button variant="ghost" size="sm" className="h-7 w-7 p-0" onClick={() => { setSelectedDocumento(gasto.archivo as Documento); setShowPreviewDialog(true) }}><Eye className="h-3 w-3 text-blue-600" /></Button><Button variant="ghost" size="sm" className="h-7 w-7 p-0" onClick={() => window.open(gasto.archivo!.ruta_archivo, '_blank')}><Download className="h-3 w-3 text-green-600" /></Button></>}<Button variant="ghost" size="sm" className="h-7 w-7 p-0" onClick={() => { setSelectedGasto(gasto); setGastoForm({ monto: String(gasto.monto), descripcion: gasto.descripcion || '', fecha_gasto: gasto.fecha_gasto.split('T')[0], tipo_comprobante: gasto.tipo_comprobante || '', numero_comprobante: gasto.numero_comprobante || '', archivo: null }); setShowEditGastoDialog(true) }}><Edit className="h-3 w-3" /></Button><Button variant="ghost" size="sm" className="h-7 w-7 p-0 text-red-600" onClick={() => { setSelectedGasto(gasto); setShowDeleteGastoDialog(true) }}><Trash2 className="h-3 w-3" /></Button></div></div>{!gasto.archivo && <div className="mt-2 flex items-center gap-1 text-xs text-amber-600"><AlertCircle className="h-3 w-3" />Sin comprobante</div>}</div>))}</div>)}
                                </TabsContent>
                              </Tabs>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </CardContent>
          </Card>
        ))}
      </div>

      {/* DIALOGS */}
      <Dialog open={showPartidaDialog} onOpenChange={setShowPartidaDialog}><DialogContent><DialogHeader><DialogTitle>Nueva Partida</DialogTitle></DialogHeader><div className="grid gap-4 py-4"><div className="grid gap-2"><Label>Nombre *</Label><Input placeholder="Ej: Estructuras" value={partidaForm.nombre_partida} onChange={(e) => setPartidaForm({ ...partidaForm, nombre_partida: e.target.value })} /></div><div className="grid gap-2"><Label>Monto (S/)</Label><Input type="number" placeholder="0.00" value={partidaForm.monto_asignado} onChange={(e) => setPartidaForm({ ...partidaForm, monto_asignado: e.target.value })} /></div><div className="grid gap-2"><Label>Archivo (opcional)</Label><div className="border-2 border-dashed rounded-lg p-4">{partidaForm.archivo ? (<div className="flex items-center justify-between"><div className="flex items-center gap-2"><FileText className="h-5 w-5 text-blue-500" /><span className="text-sm">{partidaForm.archivo.name}</span></div><Button variant="ghost" size="sm" onClick={() => setPartidaForm({ ...partidaForm, archivo: null })}><X className="h-4 w-4" /></Button></div>) : (<label className="flex flex-col items-center gap-2 cursor-pointer"><Upload className="h-6 w-6 text-gray-400" /><span className="text-sm text-gray-500">Click para seleccionar</span><input type="file" className="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" onChange={(e) => { const f = e.target.files?.[0]; if (f) setPartidaForm({ ...partidaForm, archivo: f }) }} /></label>)}</div>{partidaForm.archivo && <Select value={partidaForm.carpeta_id} onValueChange={(v) => setPartidaForm({ ...partidaForm, carpeta_id: v })}><SelectTrigger><SelectValue /></SelectTrigger><SelectContent>{carpetas.map(c => <SelectItem key={c.id_carpeta_tipo} value={String(c.id_carpeta_tipo)}>{c.codigo} - {c.nombre_carpeta}</SelectItem>)}</SelectContent></Select>}</div></div><DialogFooter><Button variant="outline" onClick={() => setShowPartidaDialog(false)}>Cancelar</Button><Button onClick={handleCreatePartida} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Crear</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showEditPartidaDialog} onOpenChange={setShowEditPartidaDialog}><DialogContent><DialogHeader><DialogTitle>Editar Partida</DialogTitle></DialogHeader><div className="grid gap-4 py-4"><div className="grid gap-2"><Label>Nombre *</Label><Input value={partidaForm.nombre_partida} onChange={(e) => setPartidaForm({ ...partidaForm, nombre_partida: e.target.value })} /></div><div className="grid gap-2"><Label>Monto (S/)</Label><Input type="number" value={partidaForm.monto_asignado} onChange={(e) => setPartidaForm({ ...partidaForm, monto_asignado: e.target.value })} /></div></div><DialogFooter><Button variant="outline" onClick={() => setShowEditPartidaDialog(false)}>Cancelar</Button><Button onClick={handleEditPartida} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Guardar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showDeletePartidaDialog} onOpenChange={setShowDeletePartidaDialog}><DialogContent><DialogHeader><DialogTitle>Eliminar Partida</DialogTitle><DialogDescription>¿Eliminar &quot;{selectedPartida?.nombre_partida}&quot;?</DialogDescription></DialogHeader><DialogFooter><Button variant="outline" onClick={() => setShowDeletePartidaDialog(false)}>Cancelar</Button><Button variant="destructive" onClick={handleDeletePartida} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Eliminar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showActividadDialog} onOpenChange={setShowActividadDialog}><DialogContent><DialogHeader><DialogTitle>Nueva Actividad</DialogTitle><DialogDescription>Partida: {selectedPartida?.nombre_partida}</DialogDescription></DialogHeader><div className="grid gap-4 py-4"><div className="grid gap-2"><Label>Nombre *</Label><Input placeholder="Ej: Excavación" value={actividadForm.nombre_actividad} onChange={(e) => setActividadForm({ ...actividadForm, nombre_actividad: e.target.value })} /></div><div className="grid gap-2"><Label>Descripción</Label><Textarea rows={2} value={actividadForm.descripcion} onChange={(e) => setActividadForm({ ...actividadForm, descripcion: e.target.value })} /></div><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Fecha Inicio *</Label><Input type="date" value={actividadForm.fecha_inicio} onChange={(e) => setActividadForm({ ...actividadForm, fecha_inicio: e.target.value })} /></div><div className="grid gap-2"><Label>Fecha Fin *</Label><Input type="date" value={actividadForm.fecha_fin} onChange={(e) => setActividadForm({ ...actividadForm, fecha_fin: e.target.value })} /></div></div><div className="grid gap-2"><Label>Archivo (opcional)</Label><div className="border-2 border-dashed rounded-lg p-4">{actividadForm.archivo ? (<div className="flex items-center justify-between"><div className="flex items-center gap-2"><FileText className="h-5 w-5 text-blue-500" /><span className="text-sm">{actividadForm.archivo.name}</span></div><Button variant="ghost" size="sm" onClick={() => setActividadForm({ ...actividadForm, archivo: null })}><X className="h-4 w-4" /></Button></div>) : (<label className="flex flex-col items-center gap-2 cursor-pointer"><Upload className="h-6 w-6 text-gray-400" /><span className="text-sm text-gray-500">Click para seleccionar</span><input type="file" className="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" onChange={(e) => { const f = e.target.files?.[0]; if (f) setActividadForm({ ...actividadForm, archivo: f }) }} /></label>)}</div>{actividadForm.archivo && <Select value={actividadForm.carpeta_id} onValueChange={(v) => setActividadForm({ ...actividadForm, carpeta_id: v })}><SelectTrigger><SelectValue /></SelectTrigger><SelectContent>{carpetas.map(c => <SelectItem key={c.id_carpeta_tipo} value={String(c.id_carpeta_tipo)}>{c.codigo} - {c.nombre_carpeta}</SelectItem>)}</SelectContent></Select>}</div></div><DialogFooter><Button variant="outline" onClick={() => setShowActividadDialog(false)}>Cancelar</Button><Button onClick={handleCreateActividad} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Crear</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showEditActividadDialog} onOpenChange={setShowEditActividadDialog}><DialogContent><DialogHeader><DialogTitle>Editar Actividad</DialogTitle></DialogHeader><div className="grid gap-4 py-4"><div className="grid gap-2"><Label>Nombre *</Label><Input value={actividadForm.nombre_actividad} onChange={(e) => setActividadForm({ ...actividadForm, nombre_actividad: e.target.value })} /></div><div className="grid gap-2"><Label>Descripción</Label><Textarea rows={2} value={actividadForm.descripcion} onChange={(e) => setActividadForm({ ...actividadForm, descripcion: e.target.value })} /></div><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Fecha Inicio *</Label><Input type="date" value={actividadForm.fecha_inicio} onChange={(e) => setActividadForm({ ...actividadForm, fecha_inicio: e.target.value })} /></div><div className="grid gap-2"><Label>Fecha Fin *</Label><Input type="date" value={actividadForm.fecha_fin} onChange={(e) => setActividadForm({ ...actividadForm, fecha_fin: e.target.value })} /></div></div></div><DialogFooter><Button variant="outline" onClick={() => setShowEditActividadDialog(false)}>Cancelar</Button><Button onClick={handleEditActividad} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Guardar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showDeleteActividadDialog} onOpenChange={setShowDeleteActividadDialog}><DialogContent><DialogHeader><DialogTitle>Eliminar Actividad</DialogTitle><DialogDescription>¿Eliminar &quot;{selectedActividad?.nombre_actividad}&quot;?</DialogDescription></DialogHeader><DialogFooter><Button variant="outline" onClick={() => setShowDeleteActividadDialog(false)}>Cancelar</Button><Button variant="destructive" onClick={handleDeleteActividad} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Eliminar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showGastoDialog} onOpenChange={setShowGastoDialog}><DialogContent className="max-w-lg"><DialogHeader><DialogTitle className="flex items-center gap-2"><Receipt className="h-5 w-5 text-green-600" />Registrar Gasto</DialogTitle><DialogDescription>Actividad: {selectedActividad?.nombre_actividad}</DialogDescription></DialogHeader><div className="grid gap-4 py-4"><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Monto (S/) *</Label><Input type="number" min="0.01" step="0.01" placeholder="0.00" value={gastoForm.monto} onChange={(e) => setGastoForm({ ...gastoForm, monto: e.target.value })} /></div><div className="grid gap-2"><Label>Fecha *</Label><Input type="date" value={gastoForm.fecha_gasto} onChange={(e) => setGastoForm({ ...gastoForm, fecha_gasto: e.target.value })} /></div></div><div className="grid gap-2"><Label>Descripción</Label><Textarea rows={2} placeholder="Descripción del gasto..." value={gastoForm.descripcion} onChange={(e) => setGastoForm({ ...gastoForm, descripcion: e.target.value })} /></div><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Tipo Comprobante</Label><Select value={gastoForm.tipo_comprobante} onValueChange={(v) => setGastoForm({ ...gastoForm, tipo_comprobante: v })}><SelectTrigger><SelectValue placeholder="Seleccionar" /></SelectTrigger><SelectContent>{TIPOS_COMPROBANTE.map(t => <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>)}</SelectContent></Select></div><div className="grid gap-2"><Label>N° Comprobante</Label><Input placeholder="001-00123" value={gastoForm.numero_comprobante} onChange={(e) => setGastoForm({ ...gastoForm, numero_comprobante: e.target.value })} /></div></div><div className="grid gap-2"><Label>Comprobante (archivo)</Label><div className="border-2 border-dashed rounded-lg p-4 bg-gray-50">{gastoForm.archivo ? (<div className="flex items-center justify-between"><div className="flex items-center gap-2"><FileText className="h-5 w-5 text-blue-500" /><div><p className="text-sm font-medium">{gastoForm.archivo.name}</p><p className="text-xs text-gray-400">{(gastoForm.archivo.size/1024/1024).toFixed(2)} MB</p></div></div><Button variant="ghost" size="sm" onClick={() => setGastoForm({ ...gastoForm, archivo: null })}><X className="h-4 w-4" /></Button></div>) : (<label className="flex flex-col items-center gap-2 cursor-pointer"><Upload className="h-8 w-8 text-gray-400" /><span className="text-sm text-gray-500">Click para adjuntar</span><span className="text-xs text-gray-400">PDF, imagen (máx. 10MB)</span><input type="file" className="hidden" accept=".pdf,.png,.jpg,.jpeg" onChange={(e) => { const f = e.target.files?.[0]; if (f) { if (f.size > 10*1024*1024) { toast.error('Máx 10MB'); return } setGastoForm({ ...gastoForm, archivo: f }) }}} /></label>)}</div></div></div><DialogFooter><Button variant="outline" onClick={() => setShowGastoDialog(false)}>Cancelar</Button><Button onClick={handleCreateGasto} disabled={saving} className="bg-green-600 hover:bg-green-700">{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Registrar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showEditGastoDialog} onOpenChange={setShowEditGastoDialog}><DialogContent className="max-w-lg"><DialogHeader><DialogTitle>Editar Gasto</DialogTitle></DialogHeader><div className="grid gap-4 py-4"><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Monto (S/) *</Label><Input type="number" value={gastoForm.monto} onChange={(e) => setGastoForm({ ...gastoForm, monto: e.target.value })} /></div><div className="grid gap-2"><Label>Fecha *</Label><Input type="date" value={gastoForm.fecha_gasto} onChange={(e) => setGastoForm({ ...gastoForm, fecha_gasto: e.target.value })} /></div></div><div className="grid gap-2"><Label>Descripción</Label><Textarea rows={2} value={gastoForm.descripcion} onChange={(e) => setGastoForm({ ...gastoForm, descripcion: e.target.value })} /></div><div className="grid grid-cols-2 gap-4"><div className="grid gap-2"><Label>Tipo Comprobante</Label><Select value={gastoForm.tipo_comprobante} onValueChange={(v) => setGastoForm({ ...gastoForm, tipo_comprobante: v })}><SelectTrigger><SelectValue placeholder="Seleccionar" /></SelectTrigger><SelectContent>{TIPOS_COMPROBANTE.map(t => <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>)}</SelectContent></Select></div><div className="grid gap-2"><Label>N° Comprobante</Label><Input value={gastoForm.numero_comprobante} onChange={(e) => setGastoForm({ ...gastoForm, numero_comprobante: e.target.value })} /></div></div><div className="grid gap-2"><Label>Nuevo Comprobante</Label><div className="border-2 border-dashed rounded-lg p-4 bg-gray-50">{gastoForm.archivo ? (<div className="flex items-center justify-between"><div className="flex items-center gap-2"><FileText className="h-5 w-5 text-blue-500" /><span className="text-sm">{gastoForm.archivo.name}</span></div><Button variant="ghost" size="sm" onClick={() => setGastoForm({ ...gastoForm, archivo: null })}><X className="h-4 w-4" /></Button></div>) : (<label className="flex flex-col items-center gap-2 cursor-pointer"><Upload className="h-6 w-6 text-gray-400" /><span className="text-sm text-gray-500">Click para cambiar</span><input type="file" className="hidden" accept=".pdf,.png,.jpg,.jpeg" onChange={(e) => { const f = e.target.files?.[0]; if (f) setGastoForm({ ...gastoForm, archivo: f })}} /></label>)}</div></div></div><DialogFooter><Button variant="outline" onClick={() => setShowEditGastoDialog(false)}>Cancelar</Button><Button onClick={handleEditGasto} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Guardar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showDeleteGastoDialog} onOpenChange={setShowDeleteGastoDialog}><DialogContent><DialogHeader><DialogTitle>Eliminar Gasto</DialogTitle><DialogDescription>¿Eliminar gasto de {selectedGasto && formatCurrency(Number(selectedGasto.monto))}?</DialogDescription></DialogHeader><DialogFooter><Button variant="outline" onClick={() => setShowDeleteGastoDialog(false)}>Cancelar</Button><Button variant="destructive" onClick={handleDeleteGasto} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Eliminar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showArchivoDialog} onOpenChange={setShowArchivoDialog}><DialogContent><DialogHeader><DialogTitle>Subir Archivo</DialogTitle><DialogDescription>{uploadContext.tipo === 'obra' ? 'Documento general' : uploadContext.tipo === 'partida' ? 'Archivo de partida' : 'Archivo de actividad'}</DialogDescription></DialogHeader><div className="grid gap-4 py-4"><div className="grid gap-2"><Label>Archivo *</Label><div className="border-2 border-dashed rounded-lg p-6 bg-gray-50">{archivoForm.archivo ? (<div className="flex items-center justify-between"><div className="flex items-center gap-2"><FileText className="h-6 w-6 text-blue-500" /><div><p className="text-sm font-medium">{archivoForm.archivo.name}</p><p className="text-xs text-gray-400">{(archivoForm.archivo.size/1024/1024).toFixed(2)} MB</p></div></div><Button variant="ghost" size="sm" onClick={() => setArchivoForm({ ...archivoForm, archivo: null })}><X className="h-4 w-4" /></Button></div>) : (<label className="flex flex-col items-center gap-2 cursor-pointer"><Upload className="h-10 w-10 text-gray-400" /><span className="text-sm text-gray-500">Click para seleccionar</span><span className="text-xs text-gray-400">PDF, DOC, XLSX, PNG, JPG (máx. 10MB)</span><input type="file" className="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" onChange={(e) => { const f = e.target.files?.[0]; if (f) { if (f.size > 10*1024*1024) { toast.error('Máx 10MB'); return } setArchivoForm({ ...archivoForm, archivo: f }) }}} /></label>)}</div></div><div className="grid gap-2"><Label>Carpeta *</Label><Select value={archivoForm.carpeta_id} onValueChange={(v) => setArchivoForm({ ...archivoForm, carpeta_id: v })}><SelectTrigger><SelectValue placeholder="Seleccionar" /></SelectTrigger><SelectContent>{carpetas.map(c => <SelectItem key={c.id_carpeta_tipo} value={String(c.id_carpeta_tipo)}>{c.codigo} - {c.nombre_carpeta}</SelectItem>)}</SelectContent></Select></div><div className="grid gap-2"><Label>Descripción</Label><Input placeholder="Descripción..." value={archivoForm.descripcion} onChange={(e) => setArchivoForm({ ...archivoForm, descripcion: e.target.value })} /></div></div><DialogFooter><Button variant="outline" onClick={() => setShowArchivoDialog(false)}>Cancelar</Button><Button onClick={handleUploadArchivo} disabled={saving || !archivoForm.archivo}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Subir</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showPreviewDialog} onOpenChange={setShowPreviewDialog}><DialogContent className="max-w-4xl max-h-[90vh]"><DialogHeader><DialogTitle>{selectedDocumento?.nombre_archivo}</DialogTitle><DialogDescription>{selectedDocumento?.carpeta_tipo?.nombre_carpeta} • {selectedDocumento && new Date(selectedDocumento.fecha_carga).toLocaleDateString()}</DialogDescription></DialogHeader><div className="flex-1 min-h-[60vh] bg-gray-100 rounded-lg overflow-hidden">{selectedDocumento && (['png','jpg','jpeg','gif','webp'].includes(selectedDocumento.formato.toLowerCase()) ? <img src={selectedDocumento.ruta_archivo} alt={selectedDocumento.nombre_archivo} className="w-full h-full object-contain" /> : selectedDocumento.formato.toLowerCase() === 'pdf' ? <iframe src={selectedDocumento.ruta_archivo} className="w-full h-full min-h-[60vh]" title={selectedDocumento.nombre_archivo} /> : <div className="flex flex-col items-center justify-center h-full py-12"><FileText className="h-16 w-16 text-gray-400 mb-4" /><p className="text-gray-500 mb-4">Vista previa no disponible</p><Button onClick={() => window.open(selectedDocumento.ruta_archivo, '_blank')}><Download className="h-4 w-4 mr-2" /> Descargar</Button></div>)}</div><DialogFooter><Button variant="outline" onClick={() => setShowPreviewDialog(false)}>Cerrar</Button><Button onClick={() => selectedDocumento && window.open(selectedDocumento.ruta_archivo, '_blank')}><Download className="h-4 w-4 mr-2" /> Descargar</Button></DialogFooter></DialogContent></Dialog>

      <Dialog open={showDeleteArchivoDialog} onOpenChange={setShowDeleteArchivoDialog}><DialogContent><DialogHeader><DialogTitle>Eliminar Archivo</DialogTitle><DialogDescription>¿Eliminar &quot;{selectedDocumento?.nombre_archivo}&quot;?</DialogDescription></DialogHeader><DialogFooter><Button variant="outline" onClick={() => setShowDeleteArchivoDialog(false)}>Cancelar</Button><Button variant="destructive" onClick={handleDeleteArchivo} disabled={saving}>{saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}Eliminar</Button></DialogFooter></DialogContent></Dialog>
    </div>
  )
}
